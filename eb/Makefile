.PHONY: smoketest install apply uninstall dependencies smoketest init deploy status open clean help
.DEFAULT_GOAL := help

# Load Sceptre deployment configuration (used by awsebcli)
VARS := $(shell grep -E "profile|region|project_code" ../cfn/config/config.yaml | sed -e 's/: /=/g')
$(foreach v,$(VARS),$(eval $(shell echo export $(v))))

# Load cluster stack name as generated by Sceptre (used by awsebcli)
stack := $(shell find ../cfn/config/ -mindepth 1 -maxdepth 1 -type d -printf '%f' | tr -d '/')
CLUSTER_CFN_STACK_NAME := $(project_code)-$(stack)-cluster

# Load Elastic Beanstalk "Solution Stack Name" (used by awsebcli)
CLUSTER_EB_SOLUTION_STACK_NAME := $(shell sed -n -e 's/^.*SolutionStackName: //p' ../cfn/config/locust/cluster.yaml)

install: smoketest init deploy status open ## Initialize Elastic Beanstalk and deploy the Locust test suite

apply:  deploy status open ## Deploy an updated Locust test suite to Elastic Beanstalk

uninstall: clean ## Delete the local virtual environment and temporary files

dependencies: # Install local dependencies in a local virtual environment
	$(call cyan, "make eb/$@ ...")
	pipenv --bare install

smoketest: dependencies ## Run a smoke test on the local Locust test suite
	$(call cyan, "make eb/$@ ...")
	pipenv run locust --no-web --only-summary \
		--locustfile=./locustfile.py \
		--clients=100 --hatch-rate=20 --run-time=10s

init: dependencies # (Re)initialize the EB CLI to target the Elastic Beanstalk environment
	$(call cyan, "make eb/$@ ...")
	# (Re)initialize the EB CLI to target the Elastic Beanstalk environment
	rm -rf ./.elasticbeanstalk/
	pipenv run eb init --profile $(profile) --region $(region) \
		--platform $(CLUSTER_EB_SOLUTION_STACK_NAME) \
		$(CLUSTER_CFN_STACK_NAME)

deploy: dependencies # (Re)deploy the Locust application
	$(call cyan, "make eb/$@ ...")
	pipenv run eb deploy --profile $(profile) --region $(region) \
		--staged $(CLUSTER_CFN_STACK_NAME)

status: dependencies ## Show deployment status of the Locust application
	$(call cyan, "make eb/$@ ...")
	pipenv run eb status --profile $(profile) --region $(region) \
		$(CLUSTER_CFN_STACK_NAME)

open: dependencies # Open the Locust web GUI in a web browser
	$(call cyan, "make eb/$@ ...")
	$(call cyan, "Opening Locust UI in a web browser ...")
	pipenv run eb open --profile $(profile) --region $(region) \
		$(CLUSTER_CFN_STACK_NAME)

clean: # Delete virtual environment and temporary files
	$(call cyan, "make eb/$@ ...")
	pipenv --rm
	rm -vrf __pycache__/
	rm -vrf .elasticbeanstalk/

help:
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "\033[36m%-18s\033[0m %s\n", $$1, $$2}' \
		$(MAKEFILE_LIST)

define cyan
	@tput setaf 6
	@echo $1
	@tput sgr0
endef
